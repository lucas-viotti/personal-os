# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Weekly Review

# AI-powered weekly review with accomplishments and planning insights
# Requires secrets: ATLASSIAN_*, LLM_*, SLACK_*

on:
  schedule:
    # Friday 3:00 PM BRT (18:00 UTC)
    - cron: '0 18 * * 5'
  workflow_dispatch:

env:
  LLM_MODEL: "gpt-4o-mini"

jobs:
  weekly-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      # ============================================
      # STEP 1: GATHER WEEKLY DATA
      # ============================================
      
      - name: Fetch Jira Weekly Activity
        id: jira
        continue-on-error: true
        env:
          ATLASSIAN_DOMAIN: ${{ secrets.ATLASSIAN_DOMAIN }}
          ATLASSIAN_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
        run: |
          if [ -z "$ATLASSIAN_DOMAIN" ] || [ -z "$JIRA_PROJECT" ]; then
            echo "jira_data=_Jira not configured_" >> $GITHUB_OUTPUT
            echo "jira_count=0" >> $GITHUB_OUTPUT
            echo "resolved_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Fetching weekly Jira activity..."
          
          # Use new Jira API endpoint (POST /rest/api/3/search/jql)
          # Old /rest/api/3/search was deprecated and removed (HTTP 410)
          JQL="project = ${JIRA_PROJECT} AND updated >= -7d ORDER BY updated DESC"
          
          echo "JQL: $JQL"
          
          # Create JSON payload for POST request
          JSON_PAYLOAD=$(jq -n \
            --arg jql "$JQL" \
            '{
              "jql": $jql,
              "maxResults": 50,
              "fields": ["key", "summary", "status", "updated", "resolution"]
            }')
          
          JIRA_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X POST \
            -u "${ATLASSIAN_EMAIL}:${ATLASSIAN_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://${ATLASSIAN_DOMAIN}/rest/api/3/search/jql" \
            -d "$JSON_PAYLOAD")
          
          HTTP_CODE=$(echo "$JIRA_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$JIRA_RESPONSE" | grep -v "HTTP_CODE:")
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Jira API error: HTTP $HTTP_CODE"
            RESPONSE_BODY='{"issues":[]}'
          fi
          
          JIRA_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.issues | length' 2>/dev/null || echo "0")
          RESOLVED_COUNT=$(echo "$RESPONSE_BODY" | jq -r '[.issues[]? | select(.fields.resolution != null)] | length' 2>/dev/null || echo "0")
          
          # Limit to 15 issues for weekly and truncate long summaries to avoid Slack's 3000 char limit
          JIRA_ISSUES=$(echo "$RESPONSE_BODY" | jq -r '.issues[:15]? | .[]? | "‚Ä¢ \(.key): \(.fields.summary | if length > 50 then .[:47] + "..." else . end) [\(.fields.status.name)]"' 2>/dev/null || echo "")
          
          echo "Found $JIRA_COUNT issues ($RESOLVED_COUNT resolved, showing up to 15)"
          
          if [ -z "$JIRA_ISSUES" ] || [ "$JIRA_COUNT" = "0" ]; then
            JIRA_ISSUES="_No Jira activity this week_"
          elif [ "$JIRA_COUNT" -gt 15 ]; then
            JIRA_ISSUES="${JIRA_ISSUES}\n_... and $((JIRA_COUNT - 15)) more_"
          fi
          
          echo "jira_data<<EOF" >> $GITHUB_OUTPUT
          echo "$JIRA_ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "jira_count=$JIRA_COUNT" >> $GITHUB_OUTPUT
          echo "resolved_count=$RESOLVED_COUNT" >> $GITHUB_OUTPUT

      - name: Fetch Confluence Weekly Activity
        id: confluence
        continue-on-error: true
        env:
          ATLASSIAN_DOMAIN: ${{ secrets.ATLASSIAN_DOMAIN }}
          ATLASSIAN_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          CONFLUENCE_SPACES: ${{ secrets.CONFLUENCE_SPACES }}
        run: |
          if [ -z "$ATLASSIAN_DOMAIN" ] || [ -z "$CONFLUENCE_SPACES" ]; then
            echo "confluence_data=_Confluence not configured_" >> $GITHUB_OUTPUT
            echo "confluence_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Fetching weekly Confluence activity..."
          
          ALL_PAGES=""
          TOTAL_COUNT=0
          WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%dT00:00:00 2>/dev/null || date -u -v-7d +%Y-%m-%dT00:00:00)
          
          for SPACE in $(echo $CONFLUENCE_SPACES | tr ',' ' '); do
            RESPONSE=$(curl -s -u "${ATLASSIAN_EMAIL}:${ATLASSIAN_API_TOKEN}" \
              "https://${ATLASSIAN_DOMAIN}/wiki/rest/api/content?spaceKey=${SPACE}&expand=history.lastUpdated&limit=30&orderby=history.lastUpdated%20desc" \
              2>/dev/null || echo '{"results":[]}')
            
            PAGES=$(echo "$RESPONSE" | jq -r --arg week_ago "$WEEK_AGO" \
              '.results[]? | select(.history.lastUpdated.when > $week_ago) | "‚Ä¢ \(.title)"' 2>/dev/null || echo "")
            
            if [ -n "$PAGES" ]; then
              ALL_PAGES="${ALL_PAGES}${PAGES}\n"
              COUNT=$(echo "$PAGES" | grep -c "‚Ä¢" || echo "0")
              TOTAL_COUNT=$((TOTAL_COUNT + COUNT))
            fi
          done
          
          if [ -z "$ALL_PAGES" ] || [ "$TOTAL_COUNT" = "0" ]; then
            ALL_PAGES="_No Confluence edits this week_"
          fi
          
          echo "confluence_data<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ALL_PAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "confluence_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT

      # Note: Slack message fetching requires user token (restricted in many companies)
      # For full Slack access, use the local script: scripts/logbook-local.py

      - name: Get Git Activity
        id: git_activity
        run: |
          WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%d 2>/dev/null || date -u -v-7d +%Y-%m-%d)
          
          # Count commits to Tasks folder
          COMMITS_COUNT=$(git log --since="$WEEK_AGO" --oneline -- Tasks/ 2>/dev/null | wc -l | tr -d ' ')
          
          echo "commits_count=$COMMITS_COUNT" >> $GITHUB_OUTPUT

      - name: Read All Tasks
        id: tasks
        run: |
          # Count by status and priority
          P0_COUNT=$(grep -l "priority: P0" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          P1_COUNT=$(grep -l "priority: P1" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          BLOCKED_COUNT=$(grep -l "status: b" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          DONE_COUNT=$(grep -l "status: d" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          TOTAL=$(ls Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          
          # Get task details
          TASK_DETAILS=""
          for file in Tasks/*.md; do
            [ -f "$file" ] || continue
            
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            PRIORITY=$(grep "^priority:" "$file" | sed 's/priority: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            
            case $STATUS in
              n) STATUS_TEXT="Not Started"; STATUS_EMOJI="üî¥" ;;
              s|ip) STATUS_TEXT="In Progress"; STATUS_EMOJI="üü°" ;;
              b) STATUS_TEXT="Blocked"; STATUS_EMOJI="üü†" ;;
              d) STATUS_TEXT="Done"; STATUS_EMOJI="‚úÖ" ;;
              *) STATUS_TEXT="Unknown"; STATUS_EMOJI="‚ö™" ;;
            esac
            
            TASK_DETAILS="${TASK_DETAILS}‚Ä¢ ${STATUS_EMOJI} [${PRIORITY}] ${TITLE} ‚Äî ${STATUS_TEXT}\n"
          done
          
          # P0 tasks - separated by status (no emoji on each line)
          P0_NOT_STARTED=""
          P0_IN_PROGRESS=""
          for file in $(grep -l "priority: P0" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            case $STATUS in
              n) P0_NOT_STARTED="${P0_NOT_STARTED}‚Ä¢ ${TITLE}\n" ;;
              s|ip|b) P0_IN_PROGRESS="${P0_IN_PROGRESS}‚Ä¢ ${TITLE}\n" ;;
            esac
          done
          
          # Check backlog
          BACKLOG_ITEMS=""
          if [ -f "BACKLOG.md" ]; then
            BACKLOG_LINES=$(grep -c "^-\|^\*\|^[0-9]" BACKLOG.md 2>/dev/null || echo "0")
            if [ "$BACKLOG_LINES" -gt 0 ]; then
              BACKLOG_ITEMS="$BACKLOG_LINES items pending"
            else
              BACKLOG_ITEMS="‚úÖ Clear!"
            fi
          else
            BACKLOG_ITEMS="‚úÖ Clear!"
          fi
          
          # Outputs
          echo "p0_count=$P0_COUNT" >> $GITHUB_OUTPUT
          echo "p1_count=$P1_COUNT" >> $GITHUB_OUTPUT
          echo "blocked_count=$BLOCKED_COUNT" >> $GITHUB_OUTPUT
          echo "done_count=$DONE_COUNT" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "backlog_items=$BACKLOG_ITEMS" >> $GITHUB_OUTPUT
          
          echo "task_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TASK_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "p0_not_started<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P0_NOT_STARTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "p0_in_progress<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P0_IN_PROGRESS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ============================================
      # STEP 2: AI ANALYSIS
      # ============================================
      
      - name: Generate AI Weekly Insights
        id: ai_analysis
        continue-on-error: true
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL_SECRET: ${{ secrets.LLM_MODEL }}
          JIRA_COUNT: ${{ steps.jira.outputs.jira_count }}
          RESOLVED_COUNT: ${{ steps.jira.outputs.resolved_count }}
          CONFLUENCE_COUNT: ${{ steps.confluence.outputs.confluence_count }}
          COMMITS_COUNT: ${{ steps.git_activity.outputs.commits_count }}
          P0_COUNT: ${{ steps.tasks.outputs.p0_count }}
          P1_COUNT: ${{ steps.tasks.outputs.p1_count }}
          BLOCKED_COUNT: ${{ steps.tasks.outputs.blocked_count }}
          DONE_COUNT: ${{ steps.tasks.outputs.done_count }}
          TOTAL_TASKS: ${{ steps.tasks.outputs.total }}
          BACKLOG_ITEMS: ${{ steps.tasks.outputs.backlog_items }}
          TASK_DETAILS: ${{ steps.tasks.outputs.task_details }}
        run: |
          MODEL="${LLM_MODEL_SECRET:-${{ env.LLM_MODEL }}}"
          
          if [ -z "$LLM_API_KEY" ]; then
            echo "suggestions=_AI analysis not configured. Add LLM_API_KEY secret._" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Build prompt using heredoc
          read -r -d '' PROMPT << 'PROMPT_END' || true
          You are a productivity coach helping a Product Manager reflect on their week.
          Provide a brief weekly reflection covering key accomplishments, attention needed,
          next week focus, and housekeeping items.
          Keep it concise and motivating. Use Slack mrkdwn formatting (bold with *, bullets with ‚Ä¢).
          When listing tasks, use emoji circles to indicate status:
          ‚Ä¢ üî¥ for not started tasks
          ‚Ä¢ üü° for in progress tasks
          ‚Ä¢ üü† for blocked tasks
          Do NOT add text labels like "(P0 NOT STARTED)" - just use the emoji prefix.
          PROMPT_END
          
          PROMPT="$PROMPT

          WEEK ENDING: $(date +'%B %d, %Y')
          
          Activity: Jira $JIRA_COUNT touched / $RESOLVED_COUNT resolved | Confluence $CONFLUENCE_COUNT | Commits $COMMITS_COUNT
          Tasks: P0=$P0_COUNT P1=$P1_COUNT Blocked=$BLOCKED_COUNT Done=$DONE_COUNT Total=$TOTAL_TASKS
          Backlog: $BACKLOG_ITEMS
          
          All Tasks: $TASK_DETAILS"

          API_URL="${LLM_API_URL:-https://api.openai.com}"
          
          echo "Calling LLM API at $API_URL..."
          
          AI_RESPONSE=$(curl -s -X POST "${API_URL}/v1/chat/completions" \
            -H "Authorization: Bearer $LLM_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" --arg model "$MODEL" \
              '{
                "model": $model,
                "messages": [{"role": "user", "content": $prompt}],
                "max_tokens": 700,
                "temperature": 0.7
              }')" 2>&1)
          
          echo "API Response: $AI_RESPONSE"
          
          AI_SUGGESTIONS=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content // empty' 2>/dev/null)
          
          if [ -z "$AI_SUGGESTIONS" ]; then
            ERROR_MSG=$(echo "$AI_RESPONSE" | jq -r '.error.message // empty' 2>/dev/null)
            if [ -n "$ERROR_MSG" ]; then
              AI_SUGGESTIONS="_AI error: ${ERROR_MSG}_"
            else
              AI_SUGGESTIONS="_AI analysis unavailable_"
            fi
          fi
          
          echo "suggestions<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_SUGGESTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ============================================
      # STEP 3: BUILD AND SEND REPORT
      # ============================================
      
      - name: Build Slack Message
        id: report
        env:
          JIRA_COUNT: ${{ steps.jira.outputs.jira_count }}
          RESOLVED_COUNT: ${{ steps.jira.outputs.resolved_count }}
          CONFLUENCE_COUNT: ${{ steps.confluence.outputs.confluence_count }}
          COMMITS_COUNT: ${{ steps.git_activity.outputs.commits_count }}
          P0_COUNT: ${{ steps.tasks.outputs.p0_count }}
          P1_COUNT: ${{ steps.tasks.outputs.p1_count }}
          BLOCKED_COUNT: ${{ steps.tasks.outputs.blocked_count }}
          DONE_COUNT: ${{ steps.tasks.outputs.done_count }}
          TOTAL_TASKS: ${{ steps.tasks.outputs.total }}
          P0_NOT_STARTED: ${{ steps.tasks.outputs.p0_not_started }}
          P0_IN_PROGRESS: ${{ steps.tasks.outputs.p0_in_progress }}
          BACKLOG_ITEMS: ${{ steps.tasks.outputs.backlog_items }}
          AI_SUGGESTIONS: ${{ steps.ai_analysis.outputs.suggestions }}
        run: |
          REPORT="*üìÖ Weekly Review ‚Äî Week of $(date +'%B %d, %Y')*\n\n"
          
          # This Week's Activity
          REPORT+="*üìà This Week's Activity*\n"
          REPORT+="‚Ä¢ üìã Jira: *${JIRA_COUNT:-0}* touched, *${RESOLVED_COUNT:-0}* resolved\n"
          REPORT+="‚Ä¢ üìù Confluence: *${CONFLUENCE_COUNT:-0}* pages edited\n"
          REPORT+="‚Ä¢ üí¨ Slack: _Ask Cursor IDE for context_\n"
          REPORT+="‚Ä¢ üìÅ Task commits: *${COMMITS_COUNT:-0}*\n\n"
          
          # Task Overview
          REPORT+="*üìã Task Overview*\n"
          REPORT+="‚Ä¢ üö® P0 (Critical): *${P0_COUNT:-0}*\n"
          REPORT+="‚Ä¢ ‚ö° P1 (This Week): *${P1_COUNT:-0}*\n"
          REPORT+="‚Ä¢ üü† Blocked: *${BLOCKED_COUNT:-0}*\n"
          REPORT+="‚Ä¢ ‚úÖ Done: *${DONE_COUNT:-0}*\n"
          REPORT+="‚Ä¢ üìä Total Active: *${TOTAL_TASKS:-0}*\n\n"
          
          # P0 Tasks - grouped by status
          if [ "${P0_COUNT:-0}" -gt 0 ]; then
            REPORT+="*üö® P0 Tasks*\n"
            if [ -n "$P0_NOT_STARTED" ] && [ "$P0_NOT_STARTED" != "\n" ]; then
              REPORT+="*üî¥ Not started*\n"
              REPORT+="${P0_NOT_STARTED}"
            fi
            if [ -n "$P0_IN_PROGRESS" ] && [ "$P0_IN_PROGRESS" != "\n" ]; then
              REPORT+="*üü° In Progress*\n"
              REPORT+="${P0_IN_PROGRESS}"
            fi
            REPORT+="\n"
          fi
          
          # Backlog
          REPORT+="*üì• Backlog:* ${BACKLOG_ITEMS}\n\n"
          
          REPORT+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
          
          # AI Insights
          REPORT+="*üí° AI Weekly Insights*\n"
          REPORT+="${AI_SUGGESTIONS:-_AI analysis not available_}\n\n"
          
          REPORT+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
          REPORT+="_Open Cursor IDE for full interactive weekly reflection_"
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "Weekly Review",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.report.outputs.report) }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
