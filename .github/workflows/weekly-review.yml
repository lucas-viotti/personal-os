# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Weekly Review

# AI-powered weekly review with accomplishments and planning insights
# Customize the schedule, LLM provider, and integrations below

on:
  schedule:
    # Default: Friday 3:00 PM UTC - Adjust for your timezone
    # Examples: EST = 20:00 UTC, PST = 23:00 UTC, BRT = 18:00 UTC
    - cron: '0 15 * * 5'
  workflow_dispatch:  # Allow manual trigger

# =============================================================================
# CONFIGURATION - Customize these for your setup
# =============================================================================
env:
  # Atlassian Configuration (optional - set to empty to skip)
  ATLASSIAN_DOMAIN: ""  # e.g., "your-company.atlassian.net"
  JIRA_PROJECT: ""      # e.g., "PROJ" - your Jira project key
  CONFLUENCE_SPACES: "" # e.g., "TEAM,DOCS" - comma-separated space keys
  
  # LLM Configuration
  # Supports any OpenAI-compatible API (OpenAI, Azure, Anthropic proxy, local LLMs)
  LLM_MODEL: "gpt-4"    # Model to use for AI analysis

jobs:
  weekly-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit analysis

      # ============================================
      # STEP 1: GATHER DATA (Last 7 days)
      # ============================================
      
      - name: Fetch Jira Activity (Optional)
        id: jira
        if: ${{ env.ATLASSIAN_DOMAIN != '' && env.JIRA_PROJECT != '' }}
        run: |
          echo "Fetching weekly Jira activity..."
          
          WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%d 2>/dev/null || date -u -v-7d +%Y-%m-%d)
          JQL="project = ${{ env.JIRA_PROJECT }} AND updated >= '$WEEK_AGO' AND (assignee = currentUser() OR reporter = currentUser()) ORDER BY updated DESC"
          JQL_ENCODED=$(echo "$JQL" | jq -sRr @uri)
          
          JIRA_RESPONSE=$(curl -s -u "${{ secrets.ATLASSIAN_EMAIL }}:${{ secrets.ATLASSIAN_API_TOKEN }}" \
            "https://${{ env.ATLASSIAN_DOMAIN }}/rest/api/3/search?jql=${JQL_ENCODED}&maxResults=50&fields=key,summary,status,resolutiondate" \
            2>/dev/null || echo '{"issues":[]}')
          
          JIRA_COUNT=$(echo "$JIRA_RESPONSE" | jq -r '.issues | length' 2>/dev/null || echo "0")
          RESOLVED_COUNT=$(echo "$JIRA_RESPONSE" | jq -r '[.issues[] | select(.fields.resolutiondate != null)] | length' 2>/dev/null || echo "0")
          
          JIRA_ISSUES=""
          if [ "$JIRA_COUNT" != "0" ]; then
            while IFS= read -r line; do
              KEY=$(echo "$line" | jq -r '.key')
              SUMMARY=$(echo "$line" | jq -r '.fields.summary' | cut -c1-50)
              STATUS=$(echo "$line" | jq -r '.fields.status.name')
              JIRA_ISSUES="${JIRA_ISSUES}â€¢ *${KEY}*: ${SUMMARY}... [${STATUS}]\n"
            done < <(echo "$JIRA_RESPONSE" | jq -c '.issues[]' | head -15)
            
            if [ "$JIRA_COUNT" -gt 15 ]; then
              JIRA_ISSUES="${JIRA_ISSUES}_...and $((JIRA_COUNT - 15)) more_\n"
            fi
          else
            JIRA_ISSUES="_No Jira activity this week_"
          fi
          
          echo "jira_data<<EOF" >> $GITHUB_OUTPUT
          echo -e "$JIRA_ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "jira_count=$JIRA_COUNT" >> $GITHUB_OUTPUT
          echo "resolved_count=$RESOLVED_COUNT" >> $GITHUB_OUTPUT

      - name: Fetch Confluence Activity (Optional)
        id: confluence
        if: ${{ env.ATLASSIAN_DOMAIN != '' && env.CONFLUENCE_SPACES != '' }}
        run: |
          echo "Fetching weekly Confluence activity..."
          
          SPACES="${{ env.CONFLUENCE_SPACES }}"
          ALL_PAGES=""
          PAGE_COUNT=0
          
          for SPACE in $(echo $SPACES | tr ',' ' '); do
            RESPONSE=$(curl -s -u "${{ secrets.ATLASSIAN_EMAIL }}:${{ secrets.ATLASSIAN_API_TOKEN }}" \
              "https://${{ env.ATLASSIAN_DOMAIN }}/wiki/rest/api/content?spaceKey=${SPACE}&expand=history.lastUpdated&limit=30&orderby=modified desc" \
              2>/dev/null || echo '{"results":[]}')
            
            USER_EMAIL="${{ secrets.ATLASSIAN_EMAIL }}"
            WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%d 2>/dev/null || date -u -v-7d +%Y-%m-%d)
            
            PAGES=$(echo "$RESPONSE" | jq -r --arg email "$USER_EMAIL" --arg weekago "$WEEK_AGO" \
              '.results[]? | select(.history.lastUpdated.when >= $weekago) | select(.history.lastUpdated.by.email == $email) | "â€¢ *\(.title)*"' \
              2>/dev/null || echo "")
            
            if [ -n "$PAGES" ]; then
              ALL_PAGES="${ALL_PAGES}${PAGES}\n"
              PAGE_COUNT=$((PAGE_COUNT + $(echo "$PAGES" | grep -c "â€¢" || echo 0)))
            fi
          done
          
          if [ -z "$ALL_PAGES" ] || [ "$PAGE_COUNT" = "0" ]; then
            ALL_PAGES="_No Confluence edits this week_"
          fi
          
          echo "confluence_data<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ALL_PAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "confluence_count=$PAGE_COUNT" >> $GITHUB_OUTPUT

      - name: Set Default Values for Skipped Steps
        id: defaults
        run: |
          echo "jira_data<<EOF" >> $GITHUB_OUTPUT
          echo "${JIRA_DATA:-_Jira integration not configured_}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "jira_count=${JIRA_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "resolved_count=${RESOLVED_COUNT:-0}" >> $GITHUB_OUTPUT
          
          echo "confluence_data<<EOF" >> $GITHUB_OUTPUT
          echo "${CONFLUENCE_DATA:-_Confluence integration not configured_}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "confluence_count=${CONFLUENCE_COUNT:-0}" >> $GITHUB_OUTPUT
        env:
          JIRA_DATA: ${{ steps.jira.outputs.jira_data }}
          JIRA_COUNT: ${{ steps.jira.outputs.jira_count }}
          RESOLVED_COUNT: ${{ steps.jira.outputs.resolved_count }}
          CONFLUENCE_DATA: ${{ steps.confluence.outputs.confluence_data }}
          CONFLUENCE_COUNT: ${{ steps.confluence.outputs.confluence_count }}

      - name: Analyze Git Activity
        id: git_activity
        run: |
          WEEK_AGO=$(date -d '7 days ago' +%Y-%m-%d 2>/dev/null || date -v-7d +%Y-%m-%d 2>/dev/null || echo "")
          
          if [ -n "$WEEK_AGO" ]; then
            COMMITS_COUNT=$(git log --since="$WEEK_AGO" --oneline -- 'Tasks/*.md' 2>/dev/null | wc -l | tr -d ' ')
            MODIFIED_FILES=$(git log --since="$WEEK_AGO" --name-only --pretty=format: -- 'Tasks/*.md' 2>/dev/null | sort -u | grep -v '^$' | wc -l | tr -d ' ')
          else
            COMMITS_COUNT=0
            MODIFIED_FILES=0
          fi
          
          echo "commits_count=$COMMITS_COUNT" >> $GITHUB_OUTPUT
          echo "modified_files=$MODIFIED_FILES" >> $GITHUB_OUTPUT

      - name: Read Current Tasks
        id: tasks
        run: |
          # Counts
          P0_COUNT=$(grep -l "priority: P0" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          P1_COUNT=$(grep -l "priority: P1" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          BLOCKED_COUNT=$(grep -l "status: b" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          DONE_COUNT=$(grep -l "status: d" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          TOTAL=$(find Tasks -name "*.md" ! -name "README.md" 2>/dev/null | wc -l | tr -d ' ')
          
          # P0 Tasks
          P0_TASKS=""
          for file in $(grep -l "priority: P0" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            case $STATUS in
              n) STATUS_TEXT="ğŸ”´ Not Started" ;;
              s|ip) STATUS_TEXT="ğŸŸ¡ In Progress" ;;
              b) STATUS_TEXT="ğŸŸ  Blocked" ;;
              d) STATUS_TEXT="âœ… Done" ;;
              *) STATUS_TEXT="âšª Unknown" ;;
            esac
            P0_TASKS="${P0_TASKS}â€¢ *${TITLE}* â€” ${STATUS_TEXT}\n"
          done
          
          # Blocked Tasks
          BLOCKED_TASKS=""
          for file in $(grep -l "status: b" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            BLOCKED_TASKS="${BLOCKED_TASKS}â€¢ ğŸŸ  ${TITLE}\n"
          done
          
          # Done Tasks (ready to archive)
          DONE_TASKS=""
          for file in $(grep -l "status: d" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            DONE_TASKS="${DONE_TASKS}â€¢ âœ… ${TITLE}\n"
          done
          
          # Full task list for AI
          TASK_DETAILS=""
          for file in Tasks/*.md; do
            [ -f "$file" ] || continue
            [ "$(basename "$file")" = "README.md" ] && continue
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            PRIORITY=$(grep "^priority:" "$file" | sed 's/priority: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            case $STATUS in n) ST="Not Started" ;; s|ip) ST="In Progress" ;; b) ST="Blocked" ;; d) ST="Done" ;; *) ST="Unknown" ;; esac
            TASK_DETAILS="${TASK_DETAILS}- ${TITLE} | ${PRIORITY} | ${ST}\n"
          done
          
          # Backlog check
          BACKLOG_ITEMS=0
          if [ -f "BACKLOG.md" ]; then
            BACKLOG_ITEMS=$(grep "^-" BACKLOG.md 2>/dev/null | wc -l | tr -d ' ')
          fi
          
          # Outputs
          echo "p0_count=$P0_COUNT" >> $GITHUB_OUTPUT
          echo "p1_count=$P1_COUNT" >> $GITHUB_OUTPUT
          echo "blocked_count=$BLOCKED_COUNT" >> $GITHUB_OUTPUT
          echo "done_count=$DONE_COUNT" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "backlog_items=$BACKLOG_ITEMS" >> $GITHUB_OUTPUT
          
          echo "p0_tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P0_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "blocked_tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BLOCKED_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "done_tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DONE_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "task_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TASK_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ============================================
      # STEP 2: AI ANALYSIS (Optional - requires LLM_API secrets)
      # ============================================
      
      - name: Generate AI Weekly Insights
        id: ai_analysis
        if: ${{ secrets.LLM_API_KEY != '' }}
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ env.LLM_MODEL }}
          JIRA_COUNT: ${{ steps.defaults.outputs.jira_count }}
          RESOLVED_COUNT: ${{ steps.defaults.outputs.resolved_count }}
          CONFLUENCE_COUNT: ${{ steps.defaults.outputs.confluence_count }}
          COMMITS_COUNT: ${{ steps.git_activity.outputs.commits_count }}
          P0_COUNT: ${{ steps.tasks.outputs.p0_count }}
          P1_COUNT: ${{ steps.tasks.outputs.p1_count }}
          BLOCKED_COUNT: ${{ steps.tasks.outputs.blocked_count }}
          DONE_COUNT: ${{ steps.tasks.outputs.done_count }}
          TOTAL_TASKS: ${{ steps.tasks.outputs.total }}
          TASK_DETAILS: ${{ steps.tasks.outputs.task_details }}
          BACKLOG_ITEMS: ${{ steps.tasks.outputs.backlog_items }}
        run: |
          # Build prompt using heredoc (avoids YAML parsing issues)
          read -r -d '' CONTEXT << 'PROMPT_END' || true
          You are a productivity coach helping someone reflect on their week.
          
          Provide a brief weekly reflection covering:
          1. *Key Accomplishments* - What meaningful progress was made?
          2. *Attention Needed* - Any blocked tasks or stale items?
          3. *Next Week Focus* - Based on P0/P1, what should be the main focus?
          4. *Housekeeping* - Any tasks to archive, cancel, or backlog to process?
          
          Keep it concise and motivating. Use Slack mrkdwn formatting.
          PROMPT_END
          
          # Append dynamic data
          CONTEXT="$CONTEXT

          Week Ending: $(date +'%B %d, %Y')
          
          Weekly Activity:
          - Jira tickets touched: $JIRA_COUNT
          - Jira tickets resolved: $RESOLVED_COUNT
          - Confluence pages edited: $CONFLUENCE_COUNT
          - Task file commits: $COMMITS_COUNT
          
          Current Task Status:
          - P0 (Critical): $P0_COUNT
          - P1 (This Week): $P1_COUNT
          - Blocked: $BLOCKED_COUNT
          - Done (ready to archive): $DONE_COUNT
          - Total Active: $TOTAL_TASKS
          
          All Tasks: $TASK_DETAILS
          
          Backlog Items: $BACKLOG_ITEMS"
          
          # Call LLM API
          API_URL="${LLM_API_URL:-https://api.openai.com}"
          
          AI_RESPONSE=$(curl -s -X POST "${API_URL}/v1/chat/completions" \
            -H "Authorization: Bearer $LLM_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg context "$CONTEXT" --arg model "$LLM_MODEL" \
              '{"model": $model, "messages": [{"role": "user", "content": $context}], "max_tokens": 700, "temperature": 0.7}')" \
            2>/dev/null || echo '{"choices":[{"message":{"content":"_AI analysis unavailable_"}}]}')
          
          AI_INSIGHTS=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content // "_AI analysis unavailable_"')
          
          echo "insights<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_INSIGHTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set AI Default if Skipped
        id: ai_defaults
        run: |
          if [ -z "$AI_INSIGHTS" ]; then
            echo "insights<<EOF" >> $GITHUB_OUTPUT
            echo "_AI analysis not configured. Add LLM_API_KEY secret to enable._" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "insights<<EOF" >> $GITHUB_OUTPUT
            echo "$AI_INSIGHTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        env:
          AI_INSIGHTS: ${{ steps.ai_analysis.outputs.insights }}

      # ============================================
      # STEP 3: POST TO SLACK
      # ============================================
      
      - name: Build Slack Message
        id: report
        run: |
          REPORT="*ğŸ“‹ Weekly Review â€” Week of $(date +'%B %d, %Y')*\n\n"
          
          # Activity Summary
          REPORT+="*ğŸ“Š This Week's Activity*\n"
          REPORT+="â€¢ ğŸ“‹ Jira: *${{ steps.defaults.outputs.jira_count }}* touched, *${{ steps.defaults.outputs.resolved_count }}* resolved\n"
          REPORT+="â€¢ ğŸ“ Confluence: *${{ steps.defaults.outputs.confluence_count }}* pages edited\n"
          REPORT+="â€¢ ğŸ“ Task commits: *${{ steps.git_activity.outputs.commits_count }}*\n\n"
          
          # Task Overview
          REPORT+="*ğŸ“ˆ Task Overview*\n"
          REPORT+="â€¢ ğŸš¨ P0 (Critical): *${{ steps.tasks.outputs.p0_count }}*\n"
          REPORT+="â€¢ âš¡ P1 (This Week): *${{ steps.tasks.outputs.p1_count }}*\n"
          REPORT+="â€¢ ğŸŸ  Blocked: *${{ steps.tasks.outputs.blocked_count }}*\n"
          REPORT+="â€¢ âœ… Done: *${{ steps.tasks.outputs.done_count }}*\n"
          REPORT+="â€¢ Total Active: *${{ steps.tasks.outputs.total }}*\n\n"
          
          # P0 Tasks
          if [ "${{ steps.tasks.outputs.p0_count }}" -gt 0 ]; then
            REPORT+="*ğŸš¨ P0 Tasks*\n"
            REPORT+="${{ steps.tasks.outputs.p0_tasks }}\n"
          fi
          
          # Blocked Warning
          if [ "${{ steps.tasks.outputs.blocked_count }}" -gt 0 ]; then
            REPORT+="*âš ï¸ Blocked Tasks*\n"
            REPORT+="${{ steps.tasks.outputs.blocked_tasks }}\n"
          fi
          
          # Ready to Archive
          if [ "${{ steps.tasks.outputs.done_count }}" -gt 0 ]; then
            REPORT+="*ğŸ—‚ï¸ Ready to Archive*\n"
            REPORT+="${{ steps.tasks.outputs.done_tasks }}\n"
          fi
          
          # Backlog Status
          if [ "${{ steps.tasks.outputs.backlog_items }}" -gt 0 ]; then
            REPORT+="*ğŸ“¥ Backlog*: âš ï¸ *${{ steps.tasks.outputs.backlog_items }}* items waiting\n\n"
          else
            REPORT+="*ğŸ“¥ Backlog*: âœ… Clear!\n\n"
          fi
          
          REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
          
          # AI Insights
          REPORT+="*ğŸ’¡ AI Weekly Insights*\n"
          REPORT+="${{ steps.ai_defaults.outputs.insights }}\n\n"
          
          REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
          REPORT+="_Open your AI assistant and say \"weekly review\" for full interactive reflection_"
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        if: ${{ secrets.SLACK_BOT_TOKEN != '' }}
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "Weekly Review",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.report.outputs.report) }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
