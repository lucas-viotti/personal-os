name: Daily Briefing

# AI-powered morning briefing with task focus recommendations
# Customize the schedule, LLM provider, and integrations below

on:
  schedule:
    # Default: 8:30 AM UTC (Mon-Fri) - Adjust for your timezone
    # Examples: EST = 13:30 UTC, PST = 16:30 UTC, BRT = 11:30 UTC
    - cron: '30 8 * * 1-5'
  workflow_dispatch:  # Allow manual trigger

# =============================================================================
# CONFIGURATION - Customize these for your setup
# =============================================================================
env:
  # Atlassian Configuration (optional - set to empty to skip)
  ATLASSIAN_DOMAIN: ""  # e.g., "your-company.atlassian.net"
  JIRA_PROJECT: ""      # e.g., "PROJ" - your Jira project key
  CONFLUENCE_SPACES: "" # e.g., "TEAM,DOCS" - comma-separated space keys
  
  # LLM Configuration
  # Supports any OpenAI-compatible API (OpenAI, Azure, Anthropic proxy, local LLMs)
  LLM_MODEL: "gpt-4"    # Model to use for AI analysis

jobs:
  daily-briefing:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================
      # STEP 1: GATHER DATA (Modular for extensibility)
      # ============================================
      
      - name: Fetch Jira Activity (Optional)
        id: jira
        if: ${{ env.ATLASSIAN_DOMAIN != '' && env.JIRA_PROJECT != '' }}
        run: |
          echo "Fetching Jira activity..."
          
          YESTERDAY=$(date -u -d '24 hours ago' +%Y-%m-%d 2>/dev/null || date -u -v-24H +%Y-%m-%d)
          JQL="project = ${{ env.JIRA_PROJECT }} AND updated >= '$YESTERDAY' AND (assignee = currentUser() OR reporter = currentUser()) ORDER BY updated DESC"
          JQL_ENCODED=$(echo "$JQL" | jq -sRr @uri)
          
          JIRA_RESPONSE=$(curl -s -u "${{ secrets.ATLASSIAN_EMAIL }}:${{ secrets.ATLASSIAN_API_TOKEN }}" \
            "https://${{ env.ATLASSIAN_DOMAIN }}/rest/api/3/search?jql=${JQL_ENCODED}&maxResults=20&fields=key,summary,status,updated" \
            2>/dev/null || echo '{"issues":[]}')
          
          JIRA_ISSUES=$(echo "$JIRA_RESPONSE" | jq -r '.issues[]? | "â€¢ \(.key): \(.fields.summary) [\(.fields.status.name)]"' 2>/dev/null || echo "")
          JIRA_COUNT=$(echo "$JIRA_RESPONSE" | jq -r '.issues | length' 2>/dev/null || echo "0")
          
          if [ -z "$JIRA_ISSUES" ] || [ "$JIRA_COUNT" = "0" ]; then
            JIRA_ISSUES="_No Jira activity in the last 24h_"
          fi
          
          echo "jira_data<<EOF" >> $GITHUB_OUTPUT
          echo "$JIRA_ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "jira_count=$JIRA_COUNT" >> $GITHUB_OUTPUT

      - name: Fetch Confluence Activity (Optional)
        id: confluence
        if: ${{ env.ATLASSIAN_DOMAIN != '' && env.CONFLUENCE_SPACES != '' }}
        run: |
          echo "Fetching Confluence activity..."
          
          SPACES="${{ env.CONFLUENCE_SPACES }}"
          ALL_PAGES=""
          
          for SPACE in $(echo $SPACES | tr ',' ' '); do
            RESPONSE=$(curl -s -u "${{ secrets.ATLASSIAN_EMAIL }}:${{ secrets.ATLASSIAN_API_TOKEN }}" \
              "https://${{ env.ATLASSIAN_DOMAIN }}/wiki/rest/api/content?spaceKey=${SPACE}&expand=history.lastUpdated&limit=10" \
              2>/dev/null || echo '{"results":[]}')
            
            PAGES=$(echo "$RESPONSE" | jq -r '.results[]? | select(.history.lastUpdated.by.email == "${{ secrets.ATLASSIAN_EMAIL }}") | "â€¢ \(.title)"' 2>/dev/null || echo "")
            ALL_PAGES="${ALL_PAGES}${PAGES}"
          done
          
          if [ -z "$ALL_PAGES" ]; then
            ALL_PAGES="_No Confluence edits in the last 24h_"
          fi
          
          echo "confluence_data<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_PAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set Default Values for Skipped Steps
        id: defaults
        run: |
          # Set defaults if Atlassian integration is disabled
          echo "jira_data<<EOF" >> $GITHUB_OUTPUT
          echo "${JIRA_DATA:-_Jira integration not configured_}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "jira_count=${JIRA_COUNT:-0}" >> $GITHUB_OUTPUT
          
          echo "confluence_data<<EOF" >> $GITHUB_OUTPUT
          echo "${CONFLUENCE_DATA:-_Confluence integration not configured_}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          JIRA_DATA: ${{ steps.jira.outputs.jira_data }}
          JIRA_COUNT: ${{ steps.jira.outputs.jira_count }}
          CONFLUENCE_DATA: ${{ steps.confluence.outputs.confluence_data }}

      - name: Read Current Tasks
        id: tasks
        run: |
          # Count by priority
          P0_COUNT=$(grep -l "priority: P0" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          P1_COUNT=$(grep -l "priority: P1" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          BLOCKED_COUNT=$(grep -l "status: b" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          
          # Get P0 tasks with details
          P0_TASKS=""
          for file in $(grep -l "priority: P0" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            case $STATUS in
              n) STATUS_EMOJI="ğŸ”´" ;;
              s|ip) STATUS_EMOJI="ğŸŸ¡" ;;
              b) STATUS_EMOJI="ğŸŸ " ;;
              d) STATUS_EMOJI="âœ…" ;;
              *) STATUS_EMOJI="âšª" ;;
            esac
            P0_TASKS="${P0_TASKS}â€¢ ${STATUS_EMOJI} ${TITLE}\n"
          done
          
          # Get P1 tasks with details
          P1_TASKS=""
          for file in $(grep -l "priority: P1" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            case $STATUS in
              n) STATUS_EMOJI="ğŸ”´" ;;
              s|ip) STATUS_EMOJI="ğŸŸ¡" ;;
              b) STATUS_EMOJI="ğŸŸ " ;;
              d) STATUS_EMOJI="âœ…" ;;
              *) STATUS_EMOJI="âšª" ;;
            esac
            P1_TASKS="${P1_TASKS}â€¢ ${STATUS_EMOJI} ${TITLE}\n"
          done
          
          # Get blocked tasks
          BLOCKED_TASKS=""
          for file in $(grep -l "status: b" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            BLOCKED_TASKS="${BLOCKED_TASKS}â€¢ ğŸŸ  ${TITLE}\n"
          done
          
          # Output
          echo "p0_count=$P0_COUNT" >> $GITHUB_OUTPUT
          echo "p1_count=$P1_COUNT" >> $GITHUB_OUTPUT
          echo "blocked_count=$BLOCKED_COUNT" >> $GITHUB_OUTPUT
          
          echo "p0_tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P0_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "p1_tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P1_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "blocked_tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BLOCKED_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ============================================
      # STEP 2: AI ANALYSIS (Optional - requires LLM_API secrets)
      # ============================================
      
      - name: Generate AI Focus Suggestions
        id: ai_analysis
        if: ${{ secrets.LLM_API_KEY != '' }}
        run: |
          CONTEXT="You are a productivity assistant helping someone start their day.

TODAY'S CONTEXT:
- Date: $(date +'%A, %B %d, %Y')
- P0 Tasks (Do Today): ${{ steps.tasks.outputs.p0_count }}
- P1 Tasks (This Week): ${{ steps.tasks.outputs.p1_count }}
- Blocked Tasks: ${{ steps.tasks.outputs.blocked_count }}

P0 TASKS:
${{ steps.tasks.outputs.p0_tasks }}

P1 TASKS:
${{ steps.tasks.outputs.p1_tasks }}

BLOCKED TASKS:
${{ steps.tasks.outputs.blocked_tasks }}

RECENT EXTERNAL ACTIVITY:
Jira: ${{ steps.defaults.outputs.jira_data }}
Confluence: ${{ steps.defaults.outputs.confluence_data }}

Provide:
1. A brief 2-3 sentence focus recommendation for today
2. Identify any tasks that might need attention based on recent activity
3. Flag any potential blockers or follow-ups needed

Keep it concise. Use Slack mrkdwn formatting (bold with *, bullets with â€¢)."

          # Call LLM API (OpenAI-compatible endpoint)
          API_URL="${LLM_API_URL:-https://api.openai.com}"
          
          AI_RESPONSE=$(curl -s -X POST "${API_URL}/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.LLM_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg context "$CONTEXT" --arg model "${{ env.LLM_MODEL }}" '{
              "model": $model,
              "messages": [{"role": "user", "content": $context}],
              "max_tokens": 500,
              "temperature": 0.7
            }')" 2>/dev/null || echo '{"choices":[{"message":{"content":"_AI analysis unavailable_"}}]}')
          
          AI_SUGGESTIONS=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content // "_AI analysis unavailable_"')
          
          echo "suggestions<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_SUGGESTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}

      - name: Set AI Default if Skipped
        id: ai_defaults
        run: |
          if [ -z "$AI_SUGGESTIONS" ]; then
            echo "suggestions<<EOF" >> $GITHUB_OUTPUT
            echo "_AI analysis not configured. Add LLM_API_KEY secret to enable._" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "suggestions<<EOF" >> $GITHUB_OUTPUT
            echo "$AI_SUGGESTIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        env:
          AI_SUGGESTIONS: ${{ steps.ai_analysis.outputs.suggestions }}

      # ============================================
      # STEP 3: POST TO SLACK
      # ============================================
      
      - name: Build Slack Message
        id: report
        run: |
          REPORT="*â˜€ï¸ Daily Briefing â€” $(date +'%A, %B %d, %Y')*\n\n"
          
          # Task counts by priority
          REPORT+="*ğŸ“Š Today's Focus*\n"
          REPORT+="â€¢ ğŸš¨ P0 (Do Today): *${{ steps.tasks.outputs.p0_count }}*\n"
          REPORT+="â€¢ âš¡ P1 (This Week): *${{ steps.tasks.outputs.p1_count }}*\n"
          if [ "${{ steps.tasks.outputs.blocked_count }}" -gt 0 ]; then
            REPORT+="â€¢ ğŸŸ  Blocked: *${{ steps.tasks.outputs.blocked_count }}*\n"
          fi
          REPORT+="\n"
          
          # P0 Tasks
          if [ "${{ steps.tasks.outputs.p0_count }}" -gt 0 ]; then
            REPORT+="*ğŸš¨ P0 Tasks (Do Today)*\n"
            REPORT+="${{ steps.tasks.outputs.p0_tasks }}\n"
          fi
          
          # P1 Tasks
          if [ "${{ steps.tasks.outputs.p1_count }}" -gt 0 ]; then
            REPORT+="*âš¡ P1 Tasks (This Week)*\n"
            REPORT+="${{ steps.tasks.outputs.p1_tasks }}\n"
          fi
          
          # Blocked warning
          if [ "${{ steps.tasks.outputs.blocked_count }}" -gt 0 ]; then
            REPORT+="*âš ï¸ Blocked Tasks*\n"
            REPORT+="${{ steps.tasks.outputs.blocked_tasks }}\n"
          fi
          
          REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
          
          # AI Focus Suggestions
          REPORT+="*ğŸ’¡ AI Focus Recommendation*\n"
          REPORT+="${{ steps.ai_defaults.outputs.suggestions }}\n\n"
          
          REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
          REPORT+="_Open your AI assistant and say \"daily check\" to update tasks_"
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        if: ${{ secrets.SLACK_BOT_TOKEN != '' }}
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "Daily Briefing",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.report.outputs.report) }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

