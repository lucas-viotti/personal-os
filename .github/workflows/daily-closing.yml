# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Daily Closing

# AI-powered end-of-day summary with activity analysis
# Requires secrets: ATLASSIAN_*, LLM_*, SLACK_*

on:
  schedule:
    # 5:30 PM BRT (20:30 UTC) Mon-Fri
    - cron: '30 20 * * 1-5'
  workflow_dispatch:

env:
  LLM_MODEL: "gpt-4o-mini"

jobs:
  daily-closing:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================
      # STEP 1: GATHER TODAY'S ACTIVITY
      # ============================================
      
      - name: Check Task File Changes (Git)
        id: git_changes
        run: |
          echo "Checking for task file changes committed today..."
          
          # Get today's date at midnight for filtering
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00Z)
          
          # Get list of task files changed today (committed)
          CHANGED_FILES=$(git log --since="$TODAY_START" --name-only --pretty=format: -- Tasks/*.md Knowledge/*.md 2>/dev/null | sort -u | grep -v '^$' || echo "")
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "Found changed files:"
            echo "$CHANGED_FILES"
            
            # Get the actual diffs for task files (focus on Progress Log section)
            TASK_CHANGES=""
            for file in $CHANGED_FILES; do
              if [ -f "$file" ]; then
                FILENAME=$(basename "$file" .md)
                # Get the diff for this file from today's commits
                DIFF=$(git log --since="$TODAY_START" -p -- "$file" 2>/dev/null | grep "^+" | grep -v "^+++" | head -20 || echo "")
                if [ -n "$DIFF" ]; then
                  TASK_CHANGES="${TASK_CHANGES}üìù *${FILENAME}*:\n${DIFF}\n\n"
                fi
              fi
            done
            
            echo "task_changes<<EOF" >> $GITHUB_OUTPUT
            echo -e "$TASK_CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "changed_count=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          else
            echo "No task files changed today"
            echo "task_changes=_No task files were modified today._" >> $GITHUB_OUTPUT
            echo "changed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Fetch Jira Activity with Changes
        id: jira
        continue-on-error: true
        env:
          ATLASSIAN_DOMAIN: ${{ secrets.ATLASSIAN_DOMAIN }}
          ATLASSIAN_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
        run: |
          if [ -z "$ATLASSIAN_DOMAIN" ] || [ -z "$JIRA_PROJECT" ]; then
            echo "jira_data=_Jira not configured_" >> $GITHUB_OUTPUT
            echo "jira_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Fetching today's Jira activity with changelog from $ATLASSIAN_DOMAIN..."
          
          # Filter to issues where user is assignee, reporter, or watcher
          JQL="project = ${JIRA_PROJECT} AND (assignee = \"${ATLASSIAN_EMAIL}\" OR reporter = \"${ATLASSIAN_EMAIL}\" OR watcher = \"${ATLASSIAN_EMAIL}\") AND updated >= startOfDay() ORDER BY updated DESC"
          
          echo "JQL: $JQL"
          
          # Get issues with changelog and comments expanded
          JSON_PAYLOAD=$(jq -n \
            --arg jql "$JQL" \
            '{
              "jql": $jql,
              "maxResults": 20,
              "fields": ["key", "summary", "status", "description", "comment"],
              "expand": ["changelog"]
            }')
          
          JIRA_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X POST \
            -u "${ATLASSIAN_EMAIL}:${ATLASSIAN_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://${ATLASSIAN_DOMAIN}/rest/api/3/search/jql" \
            -d "$JSON_PAYLOAD")
          
          # Extract HTTP code and response body
          HTTP_CODE=$(echo "$JIRA_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$JIRA_RESPONSE" | grep -v "HTTP_CODE:")
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: ${RESPONSE_BODY:0:500}"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Jira API error: HTTP $HTTP_CODE"
            echo "jira_data=_Jira API error_" >> $GITHUB_OUTPUT
            echo "jira_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Parse each issue to extract ACTUAL changes (changelog, comments)
          # Only include issues with real changes, not just timestamp updates
          
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00)
          
          JIRA_DETAILED=""
          JIRA_LINKED=""
          ACTUAL_COUNT=0
          
          # Process each issue and extract today's changes
          for row in $(echo "$RESPONSE_BODY" | jq -r '.issues[] | @base64'); do
            ISSUE=$(echo "$row" | base64 -d)
            KEY=$(echo "$ISSUE" | jq -r '.key')
            SUMMARY=$(echo "$ISSUE" | jq -r '.fields.summary')
            STATUS=$(echo "$ISSUE" | jq -r '.fields.status.name')
            
            # Get today's changelog entries
            CHANGES=$(echo "$ISSUE" | jq -r --arg today "$TODAY_START" '
              .changelog.histories[]? | 
              select(.created >= $today) |
              .items[] | 
              "- \(.field): \(.fromString // "empty") ‚Üí \(.toString // "empty")"
            ' 2>/dev/null | head -5)
            
            # Get today's comments
            COMMENTS=$(echo "$ISSUE" | jq -r --arg today "$TODAY_START" '
              .fields.comment.comments[]? |
              select(.created >= $today) |
              "- Comment: \(.body.content[0].content[0].text // "comment added" | .[0:100])"
            ' 2>/dev/null | head -3)
            
            # Only include if there were actual changes or comments
            if [ -n "$CHANGES" ] || [ -n "$COMMENTS" ]; then
              ACTUAL_COUNT=$((ACTUAL_COUNT + 1))
              
              DETAIL="<https://${ATLASSIAN_DOMAIN}/browse/${KEY}|${KEY}> - ${SUMMARY}\n"
              if [ -n "$CHANGES" ]; then
                DETAIL+="${CHANGES}\n"
              fi
              if [ -n "$COMMENTS" ]; then
                DETAIL+="${COMMENTS}\n"
              fi
              
              JIRA_DETAILED+="${DETAIL}\n"
              JIRA_LINKED+="‚Ä¢ <https://${ATLASSIAN_DOMAIN}/browse/${KEY}|${KEY}>: ${SUMMARY:0:50} [${STATUS}]\n"
            fi
          done
          
          echo "Found $ACTUAL_COUNT issues with actual changes"
          
          if [ -z "$JIRA_DETAILED" ] || [ "$ACTUAL_COUNT" = "0" ]; then
            JIRA_DETAILED="_No actual Jira changes today (only timestamp updates)_"
            JIRA_LINKED="_No Jira changes today_"
          fi
          
          echo "jira_raw<<EOF" >> $GITHUB_OUTPUT
          echo -e "$JIRA_DETAILED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "jira_linked<<EOF" >> $GITHUB_OUTPUT
          echo -e "$JIRA_LINKED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "jira_count=$ACTUAL_COUNT" >> $GITHUB_OUTPUT

      - name: Fetch Confluence Activity
        id: confluence
        continue-on-error: true
        env:
          ATLASSIAN_DOMAIN: ${{ secrets.ATLASSIAN_DOMAIN }}
          ATLASSIAN_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          CONFLUENCE_SPACES: ${{ secrets.CONFLUENCE_SPACES }}
        run: |
          if [ -z "$ATLASSIAN_DOMAIN" ] || [ -z "$CONFLUENCE_SPACES" ]; then
            echo "confluence_data=_Confluence not configured_" >> $GITHUB_OUTPUT
            echo "confluence_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Fetching today's Confluence activity..."
          
          ALL_PAGES=""
          TOTAL_COUNT=0
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00)
          
          for SPACE in $(echo $CONFLUENCE_SPACES | tr ',' ' '); do
            RESPONSE=$(curl -s -u "${ATLASSIAN_EMAIL}:${ATLASSIAN_API_TOKEN}" \
              "https://${ATLASSIAN_DOMAIN}/wiki/rest/api/content?spaceKey=${SPACE}&expand=history.lastUpdated&limit=20&orderby=history.lastUpdated%20desc" \
              2>/dev/null || echo '{"results":[]}')
            
            PAGES=$(echo "$RESPONSE" | jq -r --arg today "$TODAY_START" \
              '.results[]? | select(.history.lastUpdated.when > $today) | "‚Ä¢ \(.title)"' 2>/dev/null || echo "")
            
            if [ -n "$PAGES" ]; then
              ALL_PAGES="${ALL_PAGES}${PAGES}\n"
              COUNT=$(echo "$PAGES" | grep -c "‚Ä¢" || echo "0")
              TOTAL_COUNT=$((TOTAL_COUNT + COUNT))
            fi
          done
          
          if [ -z "$ALL_PAGES" ] || [ "$TOTAL_COUNT" = "0" ]; then
            ALL_PAGES="_No Confluence edits today_"
          fi
          
          echo "confluence_data<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ALL_PAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "confluence_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT

      # Note: Slack message fetching requires user token (restricted in many companies)
      # For full Slack access, use the local script: scripts/logbook-local.py

      - name: Read Current Tasks
        id: tasks
        run: |
          TODAY=$(date +'%Y-%m-%d')
          
          # Get all active tasks with details including new schema fields
          TASK_DETAILS=""
          OVERDUE_ACTIONS=""
          BLOCKED_TASKS=""
          
          for file in Tasks/*.md; do
            [ -f "$file" ] || continue
            
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            PRIORITY=$(grep "^priority:" "$file" | sed 's/priority: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            DUE_DATE=$(grep "^due_date:" "$file" | sed 's/due_date: //' | head -1)
            NEXT_ACTION=$(grep "^next_action:" "$file" | sed 's/next_action: //' | head -1)
            NEXT_ACTION_DUE=$(grep "^next_action_due:" "$file" | sed 's/next_action_due: //' | head -1)
            BLOCKED_BY=$(grep "^blocked_by:" "$file" | sed 's/blocked_by: //' | head -1)
            
            case $STATUS in
              n) STATUS_TEXT="Not Started"; STATUS_EMOJI="üî¥" ;;
              s|ip) STATUS_TEXT="In Progress"; STATUS_EMOJI="üü°" ;;
              b) STATUS_TEXT="Blocked"; STATUS_EMOJI="üü†" ;;
              d) STATUS_TEXT="Done"; STATUS_EMOJI="‚úÖ" ;;
              *) STATUS_TEXT="Unknown"; STATUS_EMOJI="‚ö™" ;;
            esac
            
            TASK_DETAILS="${TASK_DETAILS}‚Ä¢ ${STATUS_EMOJI} [${PRIORITY}] ${TITLE}"
            if [ -n "$NEXT_ACTION" ]; then
              TASK_DETAILS="${TASK_DETAILS}\n  ‚Üí Next: ${NEXT_ACTION}"
              if [ -n "$NEXT_ACTION_DUE" ]; then
                TASK_DETAILS="${TASK_DETAILS} (due: ${NEXT_ACTION_DUE})"
              fi
            fi
            TASK_DETAILS="${TASK_DETAILS}\n"
            
            # Track overdue actions
            if [ -n "$NEXT_ACTION_DUE" ] && [ "$NEXT_ACTION_DUE" \< "$TODAY" ] && [ "$STATUS" != "b" ] && [ "$STATUS" != "d" ]; then
              OVERDUE_ACTIONS="${OVERDUE_ACTIONS}‚Ä¢ ‚ö†Ô∏è [${PRIORITY}] ${NEXT_ACTION} ‚Äî _${TITLE}_ (was due ${NEXT_ACTION_DUE})\n"
            fi
            
            # Track blocked tasks
            if [ "$STATUS" = "b" ]; then
              BLOCKED_TASKS="${BLOCKED_TASKS}‚Ä¢ üü† ${TITLE} ‚Äî _blocked by: ${BLOCKED_BY}_\n"
            fi
          done
          
          # Count by priority
          P0_COUNT=$(grep -l "priority: P0" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          P1_COUNT=$(grep -l "priority: P1" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          BLOCKED_COUNT=$(grep -l "status: b" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          
          # P0 tasks - separated by status (skip blocked)
          P0_NOT_STARTED=""
          P0_IN_PROGRESS=""
          for file in $(grep -l "priority: P0" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            [ "$STATUS" = "b" ] && continue
            case $STATUS in
              n) P0_NOT_STARTED="${P0_NOT_STARTED}‚Ä¢ ${TITLE}\n" ;;
              s|ip) P0_IN_PROGRESS="${P0_IN_PROGRESS}‚Ä¢ ${TITLE}\n" ;;
            esac
          done
          
          # P1 tasks - separated by status (skip blocked)
          P1_NOT_STARTED=""
          P1_IN_PROGRESS=""
          for file in $(grep -l "priority: P1" Tasks/*.md 2>/dev/null || echo ""); do
            TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
            STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
            [ "$STATUS" = "b" ] && continue
            case $STATUS in
              n) P1_NOT_STARTED="${P1_NOT_STARTED}‚Ä¢ ${TITLE}\n" ;;
              s|ip) P1_IN_PROGRESS="${P1_IN_PROGRESS}‚Ä¢ ${TITLE}\n" ;;
            esac
          done
          
          echo "task_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TASK_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "p0_count=$P0_COUNT" >> $GITHUB_OUTPUT
          echo "p1_count=$P1_COUNT" >> $GITHUB_OUTPUT
          echo "blocked_count=$BLOCKED_COUNT" >> $GITHUB_OUTPUT
          
          echo "p0_not_started<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P0_NOT_STARTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "p0_in_progress<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P0_IN_PROGRESS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "p1_not_started<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P1_NOT_STARTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "p1_in_progress<<EOF" >> $GITHUB_OUTPUT
          echo -e "$P1_IN_PROGRESS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "overdue_actions<<EOF" >> $GITHUB_OUTPUT
          echo -e "$OVERDUE_ACTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "blocked_tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BLOCKED_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ============================================
      # STEP 2: AI ANALYSIS
      # ============================================
      
      - name: Generate AI Summary and Suggestions
        id: ai_analysis
        continue-on-error: true
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL_SECRET: ${{ secrets.LLM_MODEL }}
          P0_COUNT: ${{ steps.tasks.outputs.p0_count }}
          P1_COUNT: ${{ steps.tasks.outputs.p1_count }}
          P0_NOT_STARTED: ${{ steps.tasks.outputs.p0_not_started }}
          P0_IN_PROGRESS: ${{ steps.tasks.outputs.p0_in_progress }}
          P1_NOT_STARTED: ${{ steps.tasks.outputs.p1_not_started }}
          P1_IN_PROGRESS: ${{ steps.tasks.outputs.p1_in_progress }}
          JIRA_COUNT: ${{ steps.jira.outputs.jira_count }}
          JIRA_RAW: ${{ steps.jira.outputs.jira_raw }}
          CONFLUENCE_COUNT: ${{ steps.confluence.outputs.confluence_count }}
          CONFLUENCE_DATA: ${{ steps.confluence.outputs.confluence_data }}
          TASK_DETAILS: ${{ steps.tasks.outputs.task_details }}
          TASK_FILE_CHANGES: ${{ steps.git_changes.outputs.task_changes }}
          CHANGED_FILES_COUNT: ${{ steps.git_changes.outputs.changed_count }}
          ATLASSIAN_DOMAIN: ${{ secrets.ATLASSIAN_DOMAIN }}
        run: |
          MODEL="${LLM_MODEL_SECRET:-${{ env.LLM_MODEL }}}"
          
          if [ -z "$LLM_API_KEY" ]; then
            echo "full_report=_AI not configured. Add LLM_API_KEY secret._" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          read -r -d '' PROMPT << 'PROMPT_END' || true
          You are a productivity assistant. Generate a Slack end-of-day report.

          CRITICAL RULES:
          1. Output must be UNDER 2500 characters total
          2. Use Slack mrkdwn: *bold*, _italic_, ‚Ä¢ for bullets
          3. ONLY report items with ACTUAL changes in the data - NEVER invent or assume
          4. If no changes, say so honestly - don't make up progress
          5. Be SPECIFIC - say exactly what changed, not vague summaries

          Generate this EXACT structure:

          *üìä Daily Closing ‚Äî [TODAY's DATE]*

          *üìà Today's Progress*
          ONLY list items from the data that had ACTUAL changes:
          ‚Ä¢ üìù *[filename]*: [quote the specific change from git diff]
          ‚Ä¢ üìã *<Jira URL|ticket> - [card name]*: [exact change from changelog - e.g., "Status: Backlog ‚Üí In Progress" or "Comment added: 'approved by stakeholder'"]
          ‚Ä¢ üìÑ *[Confluence page]*: [what was edited]
          
          SKIP any item without real changes. If nothing changed, write: "_No recorded changes today._"

          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

          *üìã Task Status*
          ONLY write about tasks that appear in Today's Progress or have suggested updates.
          *üö® P0 Tasks (Do Today)*: [If no P0 changes recorded, say "No progress recorded - task remains incomplete"]
          *‚ö° P1 Tasks (This Week)*: [Only mention tasks with actual evidence. Quote the specific change.]

          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

          *üí° Suggested Task Updates*
          Based on the ACTUAL changes above, suggest what to log:

          For P0 tasks with NO activity in the data:
          ‚Ä¢ üî¥ *[Task name]*: _No work recorded today. Reschedule to [date] or mark blocked._

          For tasks with Jira changes - use the EXACT change from data:
          ‚Ä¢ üü° *[Task name]*: _<URL|ticket>: [exact changelog entry]. Log this in the task file._

          For tasks with file changes:
          ‚Ä¢ üü° *[Task name]*: _File updated: "[quote diff]". Consider changing status._

          DO NOT suggest updates for tasks without evidence in the data.

          _üìä See thread for detailed activity (Jira & Confluence) ‚Üí_
          PROMPT_END
          
          TODAY=$(date +'%A, %B %d, %Y')
          
          PROMPT="$PROMPT

          TODAY: $TODAY
          JIRA_BASE_URL: https://${ATLASSIAN_DOMAIN}/browse/

          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          TASK FILE CHANGES ($CHANGED_FILES_COUNT files with actual changes)
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          $TASK_FILE_CHANGES

          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          CURRENT TASK STATUS
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          P0 TASKS (were due TODAY):
          Not started: $P0_NOT_STARTED
          In progress: $P0_IN_PROGRESS

          P1 TASKS (due this week):
          Not started: $P1_NOT_STARTED
          In progress: $P1_IN_PROGRESS

          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          JIRA ACTIVITY ($JIRA_COUNT issues) - Use JIRA_BASE_URL + ticket key for links
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          $JIRA_RAW

          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          CONFLUENCE ACTIVITY ($CONFLUENCE_COUNT pages)
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          $CONFLUENCE_DATA

          FULL TASK DETAILS (for matching tasks to Jira):
          $TASK_DETAILS"

          API_URL="${LLM_API_URL:-https://api.openai.com}"
          
          echo "Calling LLM to generate full report..."
          
          AI_RESPONSE=$(curl -s -X POST "${API_URL}/v1/chat/completions" \
            -H "Authorization: Bearer $LLM_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" --arg model "$MODEL" \
              '{
                "model": $model,
                "messages": [{"role": "user", "content": $prompt}],
                "max_tokens": 1200,
                "temperature": 0.5
              }')" 2>&1)
          
          echo "API Response: ${AI_RESPONSE:0:500}"
          
          FULL_REPORT=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content // empty' 2>/dev/null)
          
          if [ -z "$FULL_REPORT" ]; then
            ERROR_MSG=$(echo "$AI_RESPONSE" | jq -r '.error.message // empty' 2>/dev/null)
            FULL_REPORT="*üìä Daily Closing ‚Äî $TODAY*\n\n_AI error: ${ERROR_MSG:-unavailable}_\n\nJira: $JIRA_COUNT issues today"
          fi
          
          # Ensure output doesn't exceed Slack limit
          if [ ${#FULL_REPORT} -gt 2900 ]; then
            FULL_REPORT="${FULL_REPORT:0:2850}...\n\n_[Truncated - open Cursor for full details]_"
          fi
          
          echo "Report length: ${#FULL_REPORT} chars"
          
          echo "full_report<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ============================================
      # STEP 3: BUILD AND SEND REPORT
      # ============================================
      
      - name: Build Slack Messages
        id: report
        env:
          FULL_REPORT: ${{ steps.ai_analysis.outputs.full_report }}
          JIRA_LINKED: ${{ steps.jira.outputs.jira_linked }}
          JIRA_COUNT: ${{ steps.jira.outputs.jira_count }}
          CONFLUENCE_DATA: ${{ steps.confluence.outputs.confluence_data }}
          CONFLUENCE_COUNT: ${{ steps.confluence.outputs.confluence_count }}
        run: |
          # Main message (AI-generated)
          if [ -n "$FULL_REPORT" ]; then
            echo "main_message<<EOF" >> $GITHUB_OUTPUT
            echo "$FULL_REPORT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            REPORT="*üìä Daily Closing ‚Äî $(date +'%A, %B %d, %Y')*\n\n_AI report generation failed. Check workflow logs._"
            echo "main_message<<EOF" >> $GITHUB_OUTPUT
            echo -e "$REPORT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          # Thread reply with detailed Jira activity (with hyperlinks)
          THREAD="*üìä Today's Activity Details*\n\n"
          THREAD+="*üìã Jira (${JIRA_COUNT} issues)*\n"
          THREAD+="${JIRA_LINKED}\n"
          
          if [ "${CONFLUENCE_COUNT:-0}" -gt 0 ]; then
            THREAD+="\n*üìù Confluence*\n"
            THREAD+="${CONFLUENCE_DATA}"
          fi
          
          echo "thread_message<<EOF" >> $GITHUB_OUTPUT
          echo -e "$THREAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Main Message to Slack
        id: slack_main
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "Daily Closing",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.report.outputs.main_message) }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Send Activity Thread Reply
        if: steps.slack_main.outputs.ts != ''
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "thread_ts": "${{ steps.slack_main.outputs.ts }}",
              "text": "Today's Activity Details",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.report.outputs.thread_message) }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
