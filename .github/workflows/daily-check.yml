name: Daily Task Check

on:
  schedule:
    # 6:00 PM BRT = 21:00 UTC (Monday-Friday)
    - cron: '0 21 * * 1-5'
  workflow_dispatch:  # Allow manual trigger

jobs:
  daily-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Daily Report
        id: report
        run: |
          # Count tasks by status
          TOTAL=$(find Tasks -name "*.md" ! -name "README.md" 2>/dev/null | wc -l | tr -d ' ')
          NOT_STARTED=$(grep -l "status: n" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          STARTED=$(grep -l "status: s" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          BLOCKED=$(grep -l "status: b" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          IN_PROGRESS=$(grep -l "status: ip" Tasks/*.md 2>/dev/null | wc -l | tr -d ' ')
          
          # Build Slack-formatted message
          REPORT="*ðŸŒ… Daily Task Check â€” $(date +'%B %d, %Y')*\n\n"
          REPORT+="*ðŸ“Š Task Summary*\n"
          REPORT+="â€¢ ðŸ”´ Not Started: *$NOT_STARTED*\n"
          REPORT+="â€¢ ðŸŸ¡ In Progress: *$((STARTED + IN_PROGRESS))*\n"
          REPORT+="â€¢ ðŸŸ  Blocked: *$BLOCKED*\n"
          REPORT+="â€¢ Total Active: *$TOTAL*\n\n"
          
          # P0 Tasks
          REPORT+="*ðŸš¨ P0 Tasks (Do Today)*\n"
          P0_TASKS=$(grep -l "priority: P0" Tasks/*.md 2>/dev/null || echo "")
          if [ -z "$P0_TASKS" ]; then
            REPORT+="_No P0 tasks_\n"
          else
            for file in $P0_TASKS; do
              TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
              STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
              case $STATUS in
                n) STATUS_EMOJI="ðŸ”´" ;;
                s|ip) STATUS_EMOJI="ðŸŸ¡" ;;
                b) STATUS_EMOJI="ðŸŸ " ;;
                d) STATUS_EMOJI="âœ…" ;;
                *) STATUS_EMOJI="âšª" ;;
              esac
              REPORT+="â€¢ $STATUS_EMOJI $TITLE\n"
            done
          fi
          REPORT+="\n"
          
          # P1 Tasks
          REPORT+="*âš¡ P1 Tasks (This Week)*\n"
          P1_TASKS=$(grep -l "priority: P1" Tasks/*.md 2>/dev/null || echo "")
          if [ -z "$P1_TASKS" ]; then
            REPORT+="_No P1 tasks_\n"
          else
            for file in $P1_TASKS; do
              TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
              STATUS=$(grep "^status:" "$file" | sed 's/status: //' | head -1)
              case $STATUS in
                n) STATUS_EMOJI="ðŸ”´" ;;
                s|ip) STATUS_EMOJI="ðŸŸ¡" ;;
                b) STATUS_EMOJI="ðŸŸ " ;;
                d) STATUS_EMOJI="âœ…" ;;
                *) STATUS_EMOJI="âšª" ;;
              esac
              REPORT+="â€¢ $STATUS_EMOJI $TITLE\n"
            done
          fi
          REPORT+="\n"
          
          # Blocked tasks warning
          if [ "$BLOCKED" -gt 0 ]; then
            REPORT+="*âš ï¸ Blocked Tasks*\n"
            BLOCKED_TASKS=$(grep -l "status: b" Tasks/*.md 2>/dev/null || echo "")
            for file in $BLOCKED_TASKS; do
              TITLE=$(grep "^title:" "$file" | sed 's/title: //' | head -1)
              REPORT+="â€¢ ðŸŸ  $TITLE\n"
            done
            REPORT+="\n"
          fi
          
          REPORT+="---\n_Open Cursor and say \"daily check\" to update tasks_"
          
          # Escape for JSON
          REPORT_ESCAPED=$(echo -e "$REPORT" | jq -Rs .)
          echo "report=$REPORT_ESCAPED" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "Daily Task Check",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ steps.report.outputs.report }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
